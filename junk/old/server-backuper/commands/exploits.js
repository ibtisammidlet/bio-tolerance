const exploits = require("../data/exploits.json").filter((e) => !e.archived);
const { l } = require("../localize");

module.exports = {
  name: "exploits",
  aliases: ["exploit"],
  description: "cmd.help.commands.exploits",
  bigDescription: "cmd.bighelp.commands.exploits",
  category: "security",
  guildOnly: true,
  cooldown: 2,
  async execute(message) {
    const found = [];
    message.channel.sendTyping();
    let item = 0;
    const lastItem = exploits.length - 1 < 0 ? 0 : exploits.length - 1;
    const check = async function check() {
      const exploit = exploits[item];
      let bot = null;
      try {
        bot = await message.guild.members.fetch(exploit.bot);
      } catch {
        bot = null;
      }
      if (bot) {
        found.push({
          bot,
          name: exploit.name,
          description: exploit.description,
        });
      }
      if (item === lastItem) {
        const embed = {
          title: "Exploit check results",
          description: `Found ${found.length} exploits!`,
          color: 14895693,
          thumbnail: {
            url: "https://cdn.discordapp.com/avatars/797792817983389726/c37f92aa872ea449ff88450818cac325.png?size=256",
          },
          fields: found.map((e) => ({
            name: `${e.bot.user.tag} - ${e.name}`,
            value: e.description,
          })),
          footer: {
            text: l("requestedBy", this.language, { tag: message.author.tag }),
          },
        };
        message.author.send({
          embeds: [embed],
        });
        message.react("âœ…");
        return;
      }
      item += 1;
      process.nextTick(check);
    };
    process.nextTick(check);
  },
};
